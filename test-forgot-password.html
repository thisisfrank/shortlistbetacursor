<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password Diagnostic Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .section h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
        
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .checklist li:last-child {
            border-bottom: none;
        }
        
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.check {
            background: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Forgot Password Diagnostic Tool</h1>
        <p class="subtitle">Test your forgot password flow and diagnose configuration issues</p>
        
        <!-- Step 1: Configuration Check -->
        <div class="section">
            <h2>Step 1: Configuration Check</h2>
            <div class="input-group">
                <label for="supabaseUrl">Supabase URL:</label>
                <input type="text" id="supabaseUrl" placeholder="https://yourproject.supabase.co">
            </div>
            <div class="input-group">
                <label for="supabaseKey">Supabase Anon Key:</label>
                <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <button onclick="checkConfig()">Check Configuration</button>
            <div id="configResult" class="result"></div>
        </div>
        
        <!-- Step 2: Test Password Reset -->
        <div class="section">
            <h2>Step 2: Test Password Reset Email</h2>
            <div class="input-group">
                <label for="testEmail">Test Email Address:</label>
                <input type="email" id="testEmail" placeholder="user@example.com">
            </div>
            <div class="input-group">
                <label for="redirectUrl">Redirect URL:</label>
                <input type="text" id="redirectUrl" placeholder="https://yourdomain.com/reset-password">
            </div>
            <button onclick="testPasswordReset()" id="testBtn">Send Test Reset Email</button>
            <div id="testResult" class="result"></div>
        </div>
        
        <!-- Step 3: Configuration Checklist -->
        <div class="section">
            <h2>Step 3: Production Checklist</h2>
            <ul class="checklist">
                <li>
                    <strong>SMTP Configured in Supabase</strong>
                    <span class="status pending" id="status-smtp">VERIFY</span>
                    <div class="code">Supabase Dashboard ‚Üí Authentication ‚Üí Settings ‚Üí SMTP Settings</div>
                </li>
                <li>
                    <strong>Resend API Key Set</strong>
                    <span class="status pending" id="status-resend">VERIFY</span>
                    <div class="code">Host: smtp.resend.com, Port: 465, User: resend</div>
                </li>
                <li>
                    <strong>Site URL Configured</strong>
                    <span class="status pending" id="status-site">VERIFY</span>
                    <div class="code">Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration</div>
                </li>
                <li>
                    <strong>Redirect URLs Whitelisted</strong>
                    <span class="status pending" id="status-redirect">VERIFY</span>
                    <div class="code">Must include: https://yourdomain.com/reset-password</div>
                </li>
                <li>
                    <strong>Email Template Set</strong>
                    <span class="status pending" id="status-template">VERIFY</span>
                    <div class="code">Subject: "Reset your Shortlist Beta password"</div>
                </li>
            </ul>
            <button onclick="window.open('https://supabase.com/dashboard', '_blank')">Open Supabase Dashboard</button>
            <button onclick="window.open('https://resend.com/emails', '_blank')">Open Resend Dashboard</button>
        </div>
        
        <!-- Step 4: Debug Information -->
        <div class="section">
            <h2>Step 4: Debug Information</h2>
            <button onclick="showDebugInfo()">Show Debug Info</button>
            <div id="debugResult" class="result"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase = null;
        
        function checkConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const result = document.getElementById('configResult');
            
            if (!url || !key) {
                result.className = 'result error';
                result.innerHTML = '‚ùå Please provide both Supabase URL and Anon Key';
                return;
            }
            
            try {
                supabase = window.supabase.createClient(url, key);
                result.className = 'result success';
                result.innerHTML = `
                    ‚úÖ Configuration loaded successfully!
                    <div class="code">
                        URL: ${url}<br>
                        Key: ${key.substring(0, 20)}...
                    </div>
                    <p>You can now proceed to Step 2 to test the password reset.</p>
                `;
                
                // Update status indicators
                document.getElementById('status-smtp').className = 'status check';
                document.getElementById('status-smtp').textContent = 'READY';
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Configuration error: ${error.message}`;
            }
        }
        
        async function testPasswordReset() {
            const email = document.getElementById('testEmail').value.trim();
            const redirectUrl = document.getElementById('redirectUrl').value.trim();
            const result = document.getElementById('testResult');
            const btn = document.getElementById('testBtn');
            
            if (!supabase) {
                result.className = 'result error';
                result.innerHTML = '‚ùå Please complete Step 1 first (Check Configuration)';
                return;
            }
            
            if (!email) {
                result.className = 'result error';
                result.innerHTML = '‚ùå Please enter a test email address';
                return;
            }
            
            if (!redirectUrl) {
                result.className = 'result error';
                result.innerHTML = '‚ùå Please enter a redirect URL';
                return;
            }
            
            // Show loading
            btn.disabled = true;
            btn.innerHTML = 'Sending... <span class="loading"></span>';
            result.className = 'result info';
            result.innerHTML = 'üìß Sending password reset email...';
            
            try {
                const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectUrl
                });
                
                if (error) {
                    throw error;
                }
                
                result.className = 'result success';
                result.innerHTML = `
                    ‚úÖ Password reset email sent successfully!
                    <div class="code">
                        Email: ${email}<br>
                        Redirect URL: ${redirectUrl}
                    </div>
                    <p><strong>Next steps:</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Check the email inbox for: ${email}</li>
                        <li>Look for subject: "Reset your Shortlist Beta password"</li>
                        <li>Check spam folder if not in inbox</li>
                        <li>Click the reset link in the email</li>
                        <li>Verify it redirects to: ${redirectUrl}</li>
                    </ol>
                    <p style="margin-top: 10px;">
                        <strong>Monitoring:</strong><br>
                        ‚Ä¢ Check <a href="https://resend.com/emails" target="_blank">Resend Dashboard</a> for delivery status<br>
                        ‚Ä¢ Check Supabase Auth logs for any errors
                    </p>
                `;
                
                // Update status
                document.getElementById('status-redirect').className = 'status check';
                document.getElementById('status-redirect').textContent = 'SENT';
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `
                    ‚ùå Failed to send password reset email
                    <div class="code">Error: ${error.message}</div>
                    <p><strong>Common causes:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>SMTP not configured in Supabase Dashboard</li>
                        <li>Invalid Resend API key</li>
                        <li>Rate limit exceeded</li>
                        <li>User email not found (but Supabase hides this for security)</li>
                        <li>Redirect URL not whitelisted in Supabase</li>
                    </ul>
                    <p style="margin-top: 10px;">
                        <strong>What to check:</strong><br>
                        1. Go to Supabase Dashboard ‚Üí Authentication ‚Üí Settings<br>
                        2. Verify SMTP settings are correct<br>
                        3. Go to URL Configuration<br>
                        4. Verify redirect URL "${redirectUrl}" is in the whitelist
                    </p>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Reset Email';
            }
        }
        
        async function showDebugInfo() {
            const result = document.getElementById('debugResult');
            
            if (!supabase) {
                result.className = 'result error';
                result.innerHTML = '‚ùå Please complete Step 1 first (Check Configuration)';
                return;
            }
            
            result.className = 'result info';
            result.innerHTML = 'üîç Gathering debug information...';
            
            try {
                // Get current session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    currentURL: window.location.href,
                    supabaseURL: document.getElementById('supabaseUrl').value,
                    hasSession: !!session,
                    hasUser: !!user,
                    userEmail: user?.email || 'Not logged in',
                    sessionExpiry: session?.expires_at ? new Date(session.expires_at * 1000).toLocaleString() : 'N/A',
                    sessionError: sessionError?.message || 'None',
                    userError: userError?.message || 'None'
                };
                
                result.className = 'result info';
                result.innerHTML = `
                    <strong>Debug Information:</strong>
                    <div class="code">${JSON.stringify(debugInfo, null, 2)}</div>
                    <p><strong>URL Parameters:</strong></p>
                    <div class="code">
                        Current URL: ${window.location.href}<br>
                        Has access_token: ${window.location.search.includes('access_token') ? 'Yes' : 'No'}<br>
                        Has type=recovery: ${window.location.search.includes('type=recovery') ? 'Yes' : 'No'}
                    </div>
                    <p><strong>Browser Console:</strong></p>
                    <p style="font-size: 12px;">Open browser DevTools (F12) to see detailed logs from the application.</p>
                `;
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `‚ùå Error gathering debug info: ${error.message}`;
            }
        }
        
        // Auto-detect if we're on the reset password page
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const hasAccessToken = urlParams.get('access_token');
            const isRecovery = urlParams.get('type') === 'recovery';
            
            if (hasAccessToken && isRecovery) {
                const result = document.getElementById('debugResult');
                result.className = 'result success';
                result.innerHTML = `
                    ‚úÖ <strong>Recovery tokens detected in URL!</strong>
                    <p>This appears to be a password reset link. The tokens are present and ready to be used.</p>
                    <div class="code">
                        Access Token: ${hasAccessToken.substring(0, 30)}...<br>
                        Type: recovery
                    </div>
                    <p>The reset password page should authenticate you and allow you to set a new password.</p>
                `;
            }
        });
    </script>
</body>
</html>

